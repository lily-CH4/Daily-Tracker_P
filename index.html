<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Schedule with Timers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .completed {
            background-color: #f8f9fa;
            opacity: 0.7;
        }
        .completed .task-text {
            text-decoration: line-through;
            color: #6c757d;
        }
        .skipped {
            background-color: #fef2f2;
            opacity: 0.7;
        }
        .skipped .task-text {
            text-decoration: line-through;
            color: #dc2626;
        }
        .current-task {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            border: 3px solid #adb5bd;
            box-shadow: 0 0 20px rgba(173, 181, 189, 0.3);
            animation: glow 2s ease-in-out infinite alternate;
        }
        .current-task .task-text {
            color: #343a40;
            font-weight: 700;
            font-size: 1.1em;
        }
        @keyframes glow {
            from { box-shadow: 0 0 20px rgba(173, 181, 189, 0.3); }
            to { box-shadow: 0 0 30px rgba(173, 181, 189, 0.5); }
        }
        
        /* Circular Timer Styles */
        .circular-timer {
            position: relative;
            width: 80px;
            height: 80px;
        }
        .circular-timer svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }
        .circular-timer .timer-bg {
            fill: none;
            stroke: #e9ecef;
            stroke-width: 6;
        }
        .circular-timer .timer-progress {
            fill: none;
            stroke: #6c757d;
            stroke-width: 6;
            stroke-linecap: round;
            transition: stroke-dasharray 1s ease;
        }
        .circular-timer .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            font-weight: 600;
            color: #495057;
            text-align: center;
        }
        .timer-active .timer-progress {
            stroke: #28a745;
        }
        .timer-expired .timer-progress {
            stroke: #dc3545;
        }
        
        /* Popup Styles */
        .popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        .popup-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
            animation: slideIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Main Timer Styles */
        .main-circular-timer {
            position: relative;
            width: 200px;
            height: 200px;
        }
        .main-circular-timer svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }
        .main-circular-timer .main-timer-bg {
            fill: none;
            stroke: #e5e7eb;
            stroke-width: 8;
        }
        .main-circular-timer .main-timer-progress {
            fill: none;
            stroke: #10b981;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dasharray 1s ease;
        }
        .main-timer-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 160px;
        }
        .main-timer-time {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            line-height: 1;
        }
        .main-timer-activity {
            font-size: 0.875rem;
            font-weight: 600;
            color: #6b7280;
            margin-top: 0.25rem;
            line-height: 1.2;
        }
        .main-timer-schedule {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.125rem;
        }
        .main-timer-active .main-timer-progress {
            stroke: #10b981;
        }
        .main-timer-expired .main-timer-progress {
            stroke: #ef4444;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Daily Schedule & Tasks</h1>
            <p class="text-gray-600">Stay on track with countdown timers and manage your to-do list</p>
            
            <!-- Big Central Timer -->
            <div class="mt-6 flex flex-col items-center">
                <div id="mainTimer" class="main-circular-timer mb-4">
                    <svg width="200" height="200">
                        <circle class="main-timer-bg" cx="100" cy="100" r="90"></circle>
                        <circle class="main-timer-progress" cx="100" cy="100" r="90"></circle>
                    </svg>
                    <div class="main-timer-content">
                        <div id="mainTimerText" class="main-timer-time">--:--</div>
                        <div id="mainTimerActivity" class="main-timer-activity">No Active Task</div>
                        <div id="mainTimerSchedule" class="main-timer-schedule"></div>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button id="mainTimerBtn" onclick="toggleMainTimer()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Start Timer
                    </button>
                    <button onclick="skipToNextTask()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                        Skip to Next
                    </button>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Schedule Section -->
            <div class="lg:col-span-2">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Daily Schedule</h2>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gradient-to-r from-gray-700 to-gray-800 text-white">
                                <tr>
                                    <th class="px-6 py-4 text-left font-semibold">TIME</th>
                                    <th class="px-6 py-4 text-left font-semibold">DURATION</th>
                                    <th class="px-6 py-4 text-left font-semibold">ACTIVITY</th>
                                    <th class="px-6 py-4 text-center font-semibold">PROGRESS</th>
                                    <th class="px-6 py-4 text-center font-semibold">DONE</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleBody">
                                <!-- Schedule items will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div class="text-center mt-6 space-y-3">
                    <div class="flex gap-3 justify-center">
                        <button onclick="resetAllTasks()" class="bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-200 transform hover:scale-105">
                            Reset All Tasks
                        </button>
                        <button onclick="clearSavedProgress()" class="bg-gradient-to-r from-red-600 to-red-700 hover:from-red-700 hover:to-red-800 text-white px-6 py-3 rounded-lg font-semibold transition-all duration-200 transform hover:scale-105">
                            Clear Saved Data
                        </button>
                    </div>
                    <div class="text-sm text-gray-600">
                        <div class="flex items-center justify-center gap-4 mb-2">
                            <span><span class="inline-block w-3 h-3 bg-green-500 rounded-full mr-2"></span>Green = Completed</span>
                            <span><span class="inline-block w-3 h-3 bg-red-500 rounded-full mr-2"></span>Red = Skipped</span>
                        </div>
                        <div class="flex items-center justify-center gap-2 text-xs">
                            <span id="syncStatus" class="flex items-center gap-1">
                                <span id="syncIcon" class="w-2 h-2 bg-gray-400 rounded-full"></span>
                                <span id="syncText">Ready to sync</span>
                            </span>
                            <span id="lastSync" class="text-gray-500"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- To-Do List Section -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg p-6 sticky top-8">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">To-Do List</h2>
                        <button onclick="addNewTodo()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded-lg text-sm font-medium transition-colors">
                            + Add Task
                        </button>
                    </div>

                    <!-- Add New Todo Form -->
                    <div id="addTodoForm" class="mb-6 p-4 bg-gray-50 rounded-lg" style="display: none;">
                        <input type="text" id="newTodoText" placeholder="Enter task..." class="w-full p-2 border border-gray-300 rounded-lg mb-3 focus:ring-2 focus:ring-gray-500 focus:border-transparent">
                        <input type="date" id="newTodoDeadline" class="w-full p-2 border border-gray-300 rounded-lg mb-3 focus:ring-2 focus:ring-gray-500 focus:border-transparent">
                        <div class="flex gap-2">
                            <button onclick="saveTodo()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex-1">
                                Save
                            </button>
                            <button onclick="cancelTodo()" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex-1">
                                Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Todo Items -->
                    <div id="todoList" class="space-y-3 max-h-96 overflow-y-auto">
                        <!-- Todo items will be populated by JavaScript -->
                    </div>

                    <!-- Clear Completed Button -->
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <button onclick="clearCompleted()" class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                            Clear Completed
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Popup Container -->
    <div id="popupOverlay" class="popup-overlay" style="display: none;">
        <div class="popup-content">
            <h2 id="popupTitle" class="text-2xl font-bold text-gray-800 mb-4"></h2>
            <p id="popupMessage" class="text-gray-600 mb-6"></p>
            <button onclick="closePopup()" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                Close
            </button>
        </div>
    </div>

    <script>
        const schedule = [
            { time: '5:00 AM', duration: '5 mins', activity: 'PRAY', id: 1 },
            { time: '5:05 AM', duration: '10 mins', activity: 'MEDITATE', id: 2 },
            { time: '5:15 AM', duration: '1 hr', activity: 'EXERCISE', id: 3 },
            { time: '6:15 AM', duration: '15 mins', activity: 'SHOWER', id: 4 },
            { time: '6:30 AM', duration: '15 mins', activity: 'SKIN CARE', id: 5 },
            { time: '6:45 AM', duration: '15 mins', activity: 'BREAKFAST', id: 6 },
            { time: '7:00 AM', duration: '5 hrs', activity: 'STUDY', id: 7 },
            { time: '12:00 PM', duration: '1 hr', activity: 'LUNCH', id: 8 },
            { time: '1:00 PM', duration: '4 hrs', activity: 'STUDY', id: 9 },
            { time: '5:00 PM', duration: '1 hr', activity: 'DINNER', id: 10 },
            { time: '6:00 PM', duration: '2.5 hrs', activity: 'STUDY', id: 11 },
            { time: '8:30 PM', duration: '15 mins', activity: 'SKIN CARE', id: 12 },
            { time: '8:45 PM', duration: '10 mins', activity: 'JOURNAL', id: 13 },
            { time: '8:55 PM', duration: '5 mins', activity: 'PRAY', id: 14 },
            { time: '9:00 PM', duration: '8 hrs', activity: 'SLEEP', id: 15 }
        ];

        let taskStates = {};
        let timers = {};
        let mainTimer = null;
        let currentActiveTask = null;
        let todos = [
            { 
                id: 1, 
                text: "Processing Plant Design", 
                deadline: "2025-07-08", 
                completed: false,
                subtasks: [
                    { id: 1, text: "Roof Framing Plan", completed: false },
                    { id: 2, text: "Truss Detail", completed: false },
                    { id: 2, text: "Truss Detail", completed: false },
                    { id: 2, text: "Structural General Specifications", completed: false },
                    { id: 2, text: "Water Line Layout", completed: false },
                    { id: 2, text: "Plumbing Isometric Layout", completed: false },
                    { id: 2, text: "Lighting Layout", completed: false },
                    { id: 2, text: "Power Layout", completed: false },
                    { id: 2, text: "Plant Layout of Equipment", completed: false },
                    { id: 3, text: "Print", completed: false }
                ]
            },
            { 
                id: 2, 
                text: "Thesis", 
                deadline: "2025-08-30", 
                completed: false,
                subtasks: [
                    { id: 1, text: "Chapter 1", completed: true },
                    { id: 2, text: "Chapter 2", completed: true },
                    { id: 3, text: "Chapter 3", completed: false },
                    { id: 4, text: "Chapter 4", completed: false },
                    { id: 5, text: "Whole Paper", completed: false }
                ]

            }
        ];
        let expandedTodos = {};
        let todoIdCounter = 4;

        // Google Sheets Integration
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyjZ3CnfVM2jNUrTdcKTbKASWAuhEXaD_uLA1pj3IMLgtmXghjp0ZSDgPjXFXdx3b4ZEQ/exec';
        let syncStatus = 'idle'; // idle, syncing, success, error
        let lastSyncTime = null;

        // Google Sheets Sync Functions
        function updateSyncStatus(status, message) {
            syncStatus = status;
            const syncIcon = document.getElementById('syncIcon');
            const syncText = document.getElementById('syncText');
            const lastSyncEl = document.getElementById('lastSync');
            
            syncIcon.className = 'w-2 h-2 rounded-full';
            
            switch(status) {
                case 'syncing':
                    syncIcon.classList.add('bg-blue-500', 'animate-pulse');
                    syncText.textContent = 'Syncing...';
                    break;
                case 'success':
                    syncIcon.classList.add('bg-green-500');
                    syncText.textContent = 'Synced';
                    lastSyncTime = new Date();
                    lastSyncEl.textContent = `Last sync: ${lastSyncTime.toLocaleTimeString()}`;
                    break;
                case 'error':
                    syncIcon.classList.add('bg-red-500');
                    syncText.textContent = message || 'Sync failed';
                    break;
                default:
                    syncIcon.classList.add('bg-gray-400');
                    syncText.textContent = 'Ready to sync';
            }
        }

        async function syncToGoogleSheets() {
            if (syncStatus === 'syncing') return; // Prevent multiple simultaneous syncs
            
            updateSyncStatus('syncing');
            
            const data = {
                action: 'saveProgress',
                timestamp: new Date().toISOString(),
                taskStates: taskStates,
                todos: todos,
                expandedTodos: expandedTodos,
                todoIdCounter: todoIdCounter
            };
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        updateSyncStatus('success');
                    } else {
                        updateSyncStatus('error', result.error || 'Sync failed');
                    }
                } else {
                    updateSyncStatus('error', 'Network error');
                }
            } catch (error) {
                console.error('Sync error:', error);
                updateSyncStatus('error', 'Connection failed');
            }
        }

        async function loadFromGoogleSheets() {
            updateSyncStatus('syncing');
            
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL + '?action=loadProgress');
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        // Load task states
                        if (result.data.taskStates) {
                            taskStates = result.data.taskStates;
                        }
                        
                        // Load todos
                        if (result.data.todos) {
                            todos = result.data.todos;
                        }
                        
                        // Load expanded todos
                        if (result.data.expandedTodos) {
                            expandedTodos = result.data.expandedTodos;
                        }
                        
                        // Load todo counter
                        if (result.data.todoIdCounter) {
                            todoIdCounter = result.data.todoIdCounter;
                        }
                        
                        // Apply loaded states to UI
                        applyLoadedStates();
                        updateSyncStatus('success');
                        return true;
                    } else {
                        updateSyncStatus('success');
                        return false;
                    }
                } else {
                    updateSyncStatus('error', 'Failed to load');
                    return false;
                }
            } catch (error) {
                console.error('Load error:', error);
                updateSyncStatus('error', 'Connection failed');
                return false;
            }
        }

        function applyLoadedStates() {
            schedule.forEach(task => {
                const state = taskStates[task.id];
                if (state === 'completed') {
                    const rowElement = document.getElementById(`row-${task.id}`);
                    const completeBtn = document.getElementById(`complete-btn-${task.id}`);
                    
                    if (rowElement && completeBtn) {
                        rowElement.classList.add('completed');
                        updateScheduleProgress(task.id, 100, 'completed');
                        completeBtn.classList.add('bg-green-600', 'text-white');
                        completeBtn.classList.remove('bg-green-100', 'text-green-600');
                    }
                } else if (state === 'skipped') {
                    const rowElement = document.getElementById(`row-${task.id}`);
                    const skipBtn = document.getElementById(`skip-btn-${task.id}`);
                    
                    if (rowElement && skipBtn) {
                        rowElement.classList.add('skipped');
                        updateScheduleProgress(task.id, 100, 'skipped');
                        skipBtn.classList.add('bg-red-600', 'text-white');
                        skipBtn.classList.remove('bg-red-100', 'text-red-600');
                    }
                }
            });
        }

        function parseDuration(duration) {
            const parts = duration.toLowerCase().split(' ');
            const value = parseFloat(parts[0]);
            const unit = parts[1];
            
            if (unit.includes('min')) {
                return value * 60; // Convert to seconds
            } else if (unit.includes('hr')) {
                return value * 3600; // Convert to seconds
            }
            return 0;
        }

        function formatTime(seconds) {
            if (seconds <= 0) return "00:00";
            
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            }
        }



        function completeTask(taskId) {
            const rowElement = document.getElementById(`row-${taskId}`);
            const completeBtn = document.getElementById(`complete-btn-${taskId}`);
            const skipBtn = document.getElementById(`skip-btn-${taskId}`);
            
            taskStates[taskId] = 'completed';
            
            rowElement.classList.add('completed');
            rowElement.classList.remove('skipped');
            updateScheduleProgress(taskId, 100, 'completed');
            
            // Update button states
            completeBtn.classList.add('bg-green-600', 'text-white');
            completeBtn.classList.remove('bg-green-100', 'text-green-600');
            skipBtn.classList.remove('bg-red-600', 'text-white');
            skipBtn.classList.add('bg-red-100', 'text-red-600');
            
            // If this was the active task, stop the main timer
            if (currentActiveTask && currentActiveTask.id === taskId) {
                stopMainTimer();
                skipToNextTask();
            }
            
            saveProgress();
        }

        function skipTask(taskId) {
            const rowElement = document.getElementById(`row-${taskId}`);
            const completeBtn = document.getElementById(`complete-btn-${taskId}`);
            const skipBtn = document.getElementById(`skip-btn-${taskId}`);
            
            taskStates[taskId] = 'skipped';
            
            rowElement.classList.add('skipped');
            rowElement.classList.remove('completed');
            updateScheduleProgress(taskId, 100, 'skipped');
            
            // Update button states
            skipBtn.classList.add('bg-red-600', 'text-white');
            skipBtn.classList.remove('bg-red-100', 'text-red-600');
            completeBtn.classList.remove('bg-green-600', 'text-white');
            completeBtn.classList.add('bg-green-100', 'text-green-600');
            
            // If this was the active task, stop the main timer
            if (currentActiveTask && currentActiveTask.id === taskId) {
                stopMainTimer();
                skipToNextTask();
            }
            
            saveProgress();
        }

        function resetTask(taskId) {
            const rowElement = document.getElementById(`row-${taskId}`);
            const completeBtn = document.getElementById(`complete-btn-${taskId}`);
            const skipBtn = document.getElementById(`skip-btn-${taskId}`);
            
            taskStates[taskId] = false;
            
            rowElement.classList.remove('completed', 'skipped');
            updateScheduleProgress(taskId, 0, 'reset');
            
            // Reset button states
            completeBtn.classList.remove('bg-green-600', 'text-white');
            completeBtn.classList.add('bg-green-100', 'text-green-600');
            skipBtn.classList.remove('bg-red-600', 'text-white');
            skipBtn.classList.add('bg-red-100', 'text-red-600');
            
            saveProgress();
        }

        // Todo subtask functions
        function toggleTodoSubtask(todoId, subtaskId) {
            const todo = todos.find(t => t.id === todoId);
            if (todo && todo.subtasks) {
                const subtask = todo.subtasks.find(st => st.id === subtaskId);
                if (subtask) {
                    subtask.completed = !subtask.completed;
                    updateTodoProgress(todoId);
                    renderTodos();
                    saveProgress();
                }
            }
        }

        function addTodoSubtask(todoId) {
            const input = document.getElementById(`todo-subtask-input-${todoId}`);
            const text = input.value.trim();
            
            if (!text) return;
            
            const todo = todos.find(t => t.id === todoId);
            if (todo) {
                if (!todo.subtasks) {
                    todo.subtasks = [];
                }
                
                const maxId = todo.subtasks.length > 0 ? Math.max(...todo.subtasks.map(st => st.id)) : 0;
                todo.subtasks.push({
                    id: maxId + 1,
                    text: text,
                    completed: false
                });
                
                input.value = '';
                updateTodoProgress(todoId);
                renderTodos();
                saveProgress();
            }
        }

        function deleteTodoSubtask(todoId, subtaskId) {
            const todo = todos.find(t => t.id === todoId);
            if (todo && todo.subtasks) {
                todo.subtasks = todo.subtasks.filter(st => st.id !== subtaskId);
                updateTodoProgress(todoId);
                renderTodos();
                saveProgress();
            }
        }

        function toggleTodoExpansion(todoId) {
            expandedTodos[todoId] = !expandedTodos[todoId];
            renderTodos();
            saveProgress();
        }

        function updateTodoProgress(todoId) {
            const todo = todos.find(t => t.id === todoId);
            if (!todo || !todo.subtasks || todo.subtasks.length === 0) {
                return;
            }
            
            const completed = todo.subtasks.filter(st => st.completed).length;
            const total = todo.subtasks.length;
            const percentage = Math.round((completed / total) * 100);
            
            // Update main todo completion if all subtasks are done
            if (percentage === 100 && !todo.completed) {
                todo.completed = true;
            } else if (percentage < 100 && todo.completed) {
                todo.completed = false;
            }
        }



        function resetAllTasks() {
            if (confirm('Are you sure you want to reset all tasks and timers?')) {
                // Stop main timer
                stopMainTimer();
                
                // Reset all tasks
                schedule.forEach(task => {
                    resetTask(task.id);
                });
                
                // Update main timer display
                const firstTask = schedule[0];
                updateMainTimerDisplay(firstTask);
                
                saveProgress();
            }
        }

        // Save and Load Progress Functions
        function saveProgress() {
            const progressData = {
                taskStates: taskStates,
                todos: todos,
                expandedTodos: expandedTodos,
                todoIdCounter: todoIdCounter,
                lastSaved: new Date().toISOString()
            };
            
            // Save to local storage as backup
            localStorage.setItem('dailyScheduleProgress', JSON.stringify(progressData));
            
            // Sync to Google Sheets
            syncToGoogleSheets();
        }

        async function loadProgress() {
            // First try to load from Google Sheets
            const googleSheetsLoaded = await loadFromGoogleSheets();
            if (googleSheetsLoaded) {
                return true;
            }
            
            // Fallback to local storage
            const savedData = localStorage.getItem('dailyScheduleProgress');
            if (savedData) {
                try {
                    const progressData = JSON.parse(savedData);
                    
                    // Load task states
                    if (progressData.taskStates) {
                        taskStates = progressData.taskStates;
                    }
                    
                    // Load todos
                    if (progressData.todos) {
                        todos = progressData.todos;
                    }
                    
                    // Load expanded todos
                    if (progressData.expandedTodos) {
                        expandedTodos = progressData.expandedTodos;
                    }
                    
                    // Load todo counter
                    if (progressData.todoIdCounter) {
                        todoIdCounter = progressData.todoIdCounter;
                    }
                    
                    // Apply loaded states to UI
                    applyLoadedStates();
                    
                    return true;
                } catch (error) {
                    console.error('Error loading progress:', error);
                    return false;
                }
            }
            return false;
        }

        function clearSavedProgress() {
            if (confirm('Are you sure you want to clear all saved progress? This cannot be undone.')) {
                localStorage.removeItem('dailyScheduleProgress');
                location.reload(); // Reload page to reset everything
            }
        }

        function parseTimeToMinutes(timeStr) {
            const [time, period] = timeStr.split(' ');
            const [hours, minutes] = time.split(':').map(Number);
            let totalMinutes = hours * 60 + minutes;
            
            if (period === 'PM' && hours !== 12) {
                totalMinutes += 12 * 60;
            } else if (period === 'AM' && hours === 12) {
                totalMinutes = minutes;
            }
            
            return totalMinutes;
        }

        function getCurrentTask() {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();
            
            for (let i = 0; i < schedule.length; i++) {
                const taskStartMinutes = parseTimeToMinutes(schedule[i].time);
                const nextTaskStartMinutes = i < schedule.length - 1 ? 
                    parseTimeToMinutes(schedule[i + 1].time) : 
                    24 * 60; // End of day
                
                if (currentMinutes >= taskStartMinutes && currentMinutes < nextTaskStartMinutes) {
                    return schedule[i];
                }
            }
            
            return null;
        }

        function highlightCurrentTask() {
            // Remove previous highlighting
            schedule.forEach(task => {
                const rowElement = document.getElementById(`row-${task.id}`);
                rowElement.classList.remove('current-task');
            });
            
            // Highlight current task
            const currentTask = getCurrentTask();
            if (currentTask && !taskStates[currentTask.id]) {
                const rowElement = document.getElementById(`row-${currentTask.id}`);
                rowElement.classList.add('current-task');
            }
        }

        function showPopup(title, message) {
            document.getElementById('popupTitle').textContent = title;
            document.getElementById('popupMessage').textContent = message;
            document.getElementById('popupOverlay').style.display = 'flex';
        }

        function closePopup() {
            document.getElementById('popupOverlay').style.display = 'none';
        }

        function showTaskPopup(taskId) {
            const task = schedule.find(t => t.id === taskId);
            if (task) {
                showPopup(task.activity, `Time: ${task.time}\nDuration: ${task.duration}\n\nClick Start Timer when you're ready to begin this task!`);
            }
        }

        function startMainTimer(taskId) {
            const task = schedule.find(t => t.id === taskId);
            if (!task) return;

            currentActiveTask = task;
            const duration = parseDuration(task.duration);
            let timeLeft = duration;
            const totalDuration = duration;

            const timerContainer = document.getElementById('mainTimer');
            const progressCircle = timerContainer.querySelector('.main-timer-progress');
            const timerText = document.getElementById('mainTimerText');
            const activityText = document.getElementById('mainTimerActivity');
            const scheduleText = document.getElementById('mainTimerSchedule');
            const mainTimerBtn = document.getElementById('mainTimerBtn');
            
            const circumference = 2 * Math.PI * 90; // radius is 90

            progressCircle.style.strokeDasharray = circumference;
            progressCircle.style.strokeDashoffset = 0;
            timerContainer.classList.add('main-timer-active');
            
            activityText.textContent = task.activity;
            scheduleText.textContent = `${task.time} • ${task.duration}`;
            mainTimerBtn.textContent = 'Stop Timer';

            mainTimer = setInterval(() => {
                timeLeft--;
                const progress = (timeLeft / totalDuration) * circumference;
                progressCircle.style.strokeDashoffset = circumference - progress;
                timerText.textContent = formatTime(timeLeft);
                
                // Update schedule progress bar
                const scheduleProgress = ((totalDuration - timeLeft) / totalDuration) * 100;
                updateScheduleProgress(taskId, scheduleProgress);

                if (timeLeft <= 0) {
                    clearInterval(mainTimer);
                    mainTimer = null;
                    timerContainer.classList.remove('main-timer-active');
                    timerContainer.classList.add('main-timer-expired');
                    timerText.textContent = "TIME'S UP!";
                    mainTimerBtn.textContent = 'Start Timer';
                    
                    // Mark task as completed
                    const checkbox = document.getElementById(`check-${taskId}`);
                    checkbox.checked = true;
                    toggleTask(taskId);
                    
                    // Show popup and move to next task
                    showPopup(task.activity, `Time's up for ${task.activity}! Moving to next task...`);
                    setTimeout(() => {
                        closePopup();
                        skipToNextTask();
                    }, 3000);
                }
            }, 1000);
        }

        function stopMainTimer() {
            if (mainTimer) {
                clearInterval(mainTimer);
                mainTimer = null;
            }
            
            const timerContainer = document.getElementById('mainTimer');
            const progressCircle = timerContainer.querySelector('.main-timer-progress');
            const timerText = document.getElementById('mainTimerText');
            const activityText = document.getElementById('mainTimerActivity');
            const scheduleText = document.getElementById('mainTimerSchedule');
            const mainTimerBtn = document.getElementById('mainTimerBtn');
            
            timerContainer.classList.remove('main-timer-active', 'main-timer-expired');
            progressCircle.style.strokeDashoffset = 0;
            timerText.textContent = '--:--';
            activityText.textContent = 'No Active Task';
            scheduleText.textContent = '';
            mainTimerBtn.textContent = 'Start Timer';
            mainTimerBtn.disabled = true;
            
            if (currentActiveTask) {
                updateScheduleProgress(currentActiveTask.id, 0);
                currentActiveTask = null;
            }
        }

        function toggleMainTimer() {
            if (mainTimer) {
                stopMainTimer();
            } else {
                const nextTask = getNextIncompleteTask();
                if (nextTask) {
                    startMainTimer(nextTask.id);
                }
            }
        }

        function skipToNextTask() {
            stopMainTimer();
            const nextTask = getNextIncompleteTask();
            if (nextTask) {
                updateMainTimerDisplay(nextTask);
            }
        }

        function getNextIncompleteTask() {
            return schedule.find(task => !taskStates[task.id] || taskStates[task.id] === false);
        }

        function updateMainTimerDisplay(task) {
            if (!task) {
                document.getElementById('mainTimerText').textContent = 'ALL DONE!';
                document.getElementById('mainTimerActivity').textContent = 'No more tasks';
                document.getElementById('mainTimerSchedule').textContent = '';
                document.getElementById('mainTimerBtn').disabled = true;
                return;
            }
            
            const duration = parseDuration(task.duration);
            document.getElementById('mainTimerText').textContent = formatTime(duration);
            document.getElementById('mainTimerActivity').textContent = task.activity;
            document.getElementById('mainTimerSchedule').textContent = `${task.time} • ${task.duration}`;
            document.getElementById('mainTimerBtn').disabled = false;
            document.getElementById('mainTimerBtn').textContent = 'Start Timer';
        }

        function updateScheduleProgress(taskId, percentage, status = 'active') {
            const progressBar = document.getElementById(`progress-bar-${taskId}`);
            const progressText = document.getElementById(`progress-percentage-${taskId}`);
            
            if (progressBar && progressText) {
                progressBar.style.width = `${percentage}%`;
                progressText.textContent = `${Math.round(percentage)}%`;
                
                // Update progress bar color based on status
                progressBar.classList.remove('bg-green-500', 'bg-red-500', 'bg-gray-400');
                if (status === 'completed') {
                    progressBar.classList.add('bg-green-500');
                } else if (status === 'skipped') {
                    progressBar.classList.add('bg-red-500');
                } else {
                    progressBar.classList.add('bg-green-500');
                }
            }
        }

        function updateCurrentTime() {
            // Update highlighting for current time-based task
            highlightCurrentTask();
            
            // Update main timer display if no timer is running
            if (!mainTimer && !currentActiveTask) {
                const nextTask = getNextIncompleteTask();
                updateMainTimerDisplay(nextTask);
            }
        }

        function renderSchedule() {
            const tbody = document.getElementById('scheduleBody');
            tbody.innerHTML = '';

            schedule.forEach((task, index) => {
                const row = document.createElement('tr');
                row.id = `row-${task.id}`;
                row.className = `border-b border-gray-200 hover:bg-gray-25 transition-colors ${index % 2 === 0 ? 'bg-white' : 'bg-gray-25'}`;
                
                row.innerHTML = `
                    <td class="px-6 py-4 font-semibold text-gray-700">${task.time}</td>
                    <td class="px-6 py-4 text-gray-600">${task.duration}</td>
                    <td class="px-6 py-4">
                        <span class="task-text font-medium text-gray-800 cursor-pointer hover:text-gray-600" onclick="showTaskPopup(${task.id})">${task.activity}</span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex flex-col items-center gap-2">
                            <div class="w-20 bg-gray-200 rounded-full h-3">
                                <div id="progress-bar-${task.id}" class="bg-green-500 h-3 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <span id="progress-percentage-${task.id}" class="text-xs text-gray-600 font-medium">0%</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex gap-2 justify-center">
                            <button id="complete-btn-${task.id}" onclick="completeTask(${task.id})" class="w-8 h-8 bg-green-100 hover:bg-green-200 text-green-600 rounded border border-green-300 transition-colors" title="Complete Task">
                                ✓
                            </button>
                            <button id="skip-btn-${task.id}" onclick="skipTask(${task.id})" class="w-8 h-8 bg-red-100 hover:bg-red-200 text-red-600 rounded border border-red-300 transition-colors" title="Skip Task">
                                ✕
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
                taskStates[task.id] = false;
            });
        }

        // Todo List Functions
        function addNewTodo() {
            document.getElementById('addTodoForm').style.display = 'block';
            document.getElementById('newTodoText').focus();
        }

        function cancelTodo() {
            document.getElementById('addTodoForm').style.display = 'none';
            document.getElementById('newTodoText').value = '';
            document.getElementById('newTodoDeadline').value = '';
        }

        function saveTodo() {
            const text = document.getElementById('newTodoText').value.trim();
            const deadline = document.getElementById('newTodoDeadline').value;
            
            if (!text) {
                alert('Please enter a task description');
                return;
            }
            
            todos.push({
                id: todoIdCounter++,
                text: text,
                deadline: deadline || null,
                completed: false,
                subtasks: []
            });
            
            renderTodos();
            cancelTodo();
            saveProgress();
        }

        function toggleTodo(todoId) {
            const todo = todos.find(t => t.id === todoId);
            if (todo) {
                todo.completed = !todo.completed;
                // If marking as complete, mark all subtasks as complete
                if (todo.completed && todo.subtasks) {
                    todo.subtasks.forEach(subtask => subtask.completed = true);
                }
                // If marking as incomplete, mark all subtasks as incomplete
                if (!todo.completed && todo.subtasks) {
                    todo.subtasks.forEach(subtask => subtask.completed = false);
                }
                renderTodos();
                saveProgress();
            }
        }

        function deleteTodo(todoId) {
            if (confirm('Are you sure you want to delete this task?')) {
                todos = todos.filter(t => t.id !== todoId);
                renderTodos();
                saveProgress();
            }
        }

        function clearCompleted() {
            const completedCount = todos.filter(t => t.completed).length;
            if (completedCount === 0) {
                alert('No completed tasks to clear');
                return;
            }
            
            if (confirm(`Are you sure you want to delete ${completedCount} completed task(s)?`)) {
                todos = todos.filter(t => !t.completed);
                renderTodos();
                saveProgress();
            }
        }

        function formatDeadline(deadline) {
            if (!deadline) return '';
            
            const today = new Date();
            const deadlineDate = new Date(deadline);
            const diffTime = deadlineDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                return `<span class="text-red-600 font-semibold">Overdue</span>`;
            } else if (diffDays === 0) {
                return `<span class="text-orange-600 font-semibold">Due Today</span>`;
            } else if (diffDays === 1) {
                return `<span class="text-yellow-600 font-semibold">Due Tomorrow</span>`;
            } else if (diffDays <= 3) {
                return `<span class="text-blue-600 font-semibold">Due in ${diffDays} days</span>`;
            } else {
                return `<span class="text-gray-600">Due ${deadlineDate.toLocaleDateString()}</span>`;
            }
        }

        function renderTodos() {
            const todoList = document.getElementById('todoList');
            
            if (todos.length === 0) {
                todoList.innerHTML = '<p class="text-gray-500 text-center py-8">No tasks yet. Click "Add Task" to get started!</p>';
                return;
            }
            
            // Sort todos: incomplete first, then by deadline
            const sortedTodos = [...todos].sort((a, b) => {
                if (a.completed !== b.completed) {
                    return a.completed - b.completed;
                }
                if (a.deadline && b.deadline) {
                    return new Date(a.deadline) - new Date(b.deadline);
                }
                if (a.deadline && !b.deadline) return -1;
                if (!a.deadline && b.deadline) return 1;
                return 0;
            });
            
            todoList.innerHTML = sortedTodos.map(todo => {
                const hasSubtasks = todo.subtasks && todo.subtasks.length > 0;
                const completedSubtasks = hasSubtasks ? todo.subtasks.filter(st => st.completed).length : 0;
                const totalSubtasks = hasSubtasks ? todo.subtasks.length : 0;
                const progressPercentage = hasSubtasks ? Math.round((completedSubtasks / totalSubtasks) * 100) : 0;
                const isExpanded = expandedTodos[todo.id];
                
                return `
                    <div class="border border-gray-200 rounded-lg ${todo.completed ? 'bg-gray-50 opacity-75' : 'bg-white'} hover:shadow-sm transition-shadow">
                        <div class="flex items-start gap-3 p-3">
                            <input type="checkbox" ${todo.completed ? 'checked' : ''} 
                                   onchange="toggleTodo(${todo.id})" 
                                   class="w-5 h-5 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 focus:ring-2 cursor-pointer mt-0.5">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2">
                                    ${hasSubtasks ? `<button onclick="toggleTodoExpansion(${todo.id})" class="text-gray-500 hover:text-gray-700 text-sm font-bold">${isExpanded ? '▼' : '▶'}</button>` : ''}
                                    <p class="text-sm font-medium text-gray-800 ${todo.completed ? 'line-through text-gray-500' : ''}">${todo.text}</p>
                                </div>
                                ${todo.deadline ? `<p class="text-xs mt-1 ${hasSubtasks ? 'ml-6' : ''}">${formatDeadline(todo.deadline)}</p>` : ''}
                                ${hasSubtasks ? `
                                    <div class="mt-2 ${hasSubtasks ? 'ml-6' : ''}">
                                        <div class="flex items-center gap-2 text-xs">
                                            <div class="flex-1 bg-gray-200 rounded-full h-2">
                                                <div class="bg-green-500 h-2 rounded-full transition-all duration-300" style="width: ${progressPercentage}%"></div>
                                            </div>
                                            <span class="text-gray-600 font-medium">${progressPercentage}%</span>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                            <button onclick="deleteTodo(${todo.id})" 
                                    class="text-red-500 hover:text-red-700 text-sm font-medium transition-colors">
                                ✕
                            </button>
                        </div>
                        
                        ${isExpanded ? `
                            <div class="px-3 pb-3">
                                <div class="ml-8 space-y-2">
                                    ${hasSubtasks ? todo.subtasks.map(subtask => `
                                        <div class="flex items-center gap-2 p-2 bg-gray-50 rounded">
                                            <input type="checkbox" ${subtask.completed ? 'checked' : ''} 
                                                   onchange="toggleTodoSubtask(${todo.id}, ${subtask.id})" 
                                                   class="w-4 h-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 focus:ring-2">
                                            <span class="flex-1 text-sm ${subtask.completed ? 'line-through text-gray-500' : 'text-gray-700'}">${subtask.text}</span>
                                            <button onclick="deleteTodoSubtask(${todo.id}, ${subtask.id})" 
                                                    class="text-red-500 hover:text-red-700 text-xs">✕</button>
                                        </div>
                                    `).join('') : ''}
                                    <div class="flex gap-2 mt-3">
                                        <input type="text" id="todo-subtask-input-${todo.id}" placeholder="Add subtask..." 
                                               class="flex-1 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-gray-500 focus:border-transparent"
                                               onkeypress="if(event.key==='Enter') addTodoSubtask(${todo.id})">
                                        <button onclick="addTodoSubtask(${todo.id})" 
                                                class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs font-medium transition-colors">
                                            Add
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Initialize the schedule and todos
        async function initializeApp() {
            renderSchedule();
            
            // Load saved progress
            const progressLoaded = await loadProgress();
            if (progressLoaded) {
                console.log('Progress loaded from Google Sheets or local storage');
            }
            
            renderTodos();
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
        }
        
        // Start the app
        initializeApp();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'965717a0a0acbc3d',t:'MTc1MzU2NjQxMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
